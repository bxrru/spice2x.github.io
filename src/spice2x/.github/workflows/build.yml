name: Build Windows Executables

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/spice2x/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/spice2x/**'
  workflow_dispatch:

defaults:
  run:
    working-directory: src/spice2x

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          mingw-w64 \
          cmake \
          ninja-build \
          zip \
          ccache

    - name: Create MinGW toolchain files
      run: |
        sudo mkdir -p /usr/share/mingw

        # 32-bit toolchain
        sudo tee /usr/share/mingw/toolchain-i686-w64-mingw32.cmake > /dev/null << 'EOF'
        set(CMAKE_SYSTEM_NAME Windows)
        set(CMAKE_SYSTEM_PROCESSOR i686)

        set(CMAKE_C_COMPILER i686-w64-mingw32-gcc)
        set(CMAKE_CXX_COMPILER i686-w64-mingw32-g++)
        set(CMAKE_RC_COMPILER i686-w64-mingw32-windres)

        set(CMAKE_FIND_ROOT_PATH /usr/i686-w64-mingw32)
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
        EOF

        # 64-bit toolchain
        sudo tee /usr/share/mingw/toolchain-x86_64-w64-mingw32.cmake > /dev/null << 'EOF'
        set(CMAKE_SYSTEM_NAME Windows)
        set(CMAKE_SYSTEM_PROCESSOR x86_64)

        set(CMAKE_C_COMPILER x86_64-w64-mingw32-gcc)
        set(CMAKE_CXX_COMPILER x86_64-w64-mingw32-g++)
        set(CMAKE_RC_COMPILER x86_64-w64-mingw32-windres)

        set(CMAKE_FIND_ROOT_PATH /usr/x86_64-w64-mingw32)
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
        EOF

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ runner.os }}-mingw

    - name: Build
      run: |
        chmod +x build_all.sh
        ./build_all.sh

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: spice2x-${{ github.sha }}
        path: src/spice2x/bin/spice2x/
        retention-days: 30

    - name: Upload distribution zip
      uses: actions/upload-artifact@v4
      with:
        name: spice2x-dist-${{ github.sha }}
        path: src/spice2x/dist/*.zip
        retention-days: 30
